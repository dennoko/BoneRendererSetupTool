# Bone Renderer 自動セットアップ ツール — 使い方

このエディタ拡張は、選択したアバター（Humanoid）のルート GameObject に対して、Mecanim が認識するヒューマノイドボーンのみを抽出し、Animation Rigging の `BoneRenderer` に自動設定します。

## 前提条件
- Unity に Animation Rigging パッケージがインストールされていること（`BoneRenderer` が利用可能）
- 対象の GameObject に `Animator` が付いており、`Avatar` が Humanoid で有効であること
- 本スクリプトが `Editor` フォルダ内に入っていること

## 手順
1. ヒエラルキーで、対象の GameObject を選択します。
2. 目的に応じて次のいずれかを実行します：
   - Animator/Mecanim ベース（最も確実）
     - `Tools > Animation Rigging > Setup Bone Renderer for Humanoid`
     - または 右クリック `GameObject/Animation Rigging/Setup Bone Renderer (Humanoid via Animator)`
   - SkinnedMesh 由来（衣装の実使用ボーンを取得）
     - 右クリック `GameObject/Animation Rigging/Setup Bone Renderer (From Skinned Meshes)`
     - まず Humanoid 関連ボーン（親鎖に Humanoid ボーンが存在）でフィルタし、見つからなければ SMR 全ボーンを登録します。
   - 名前ベース（Animator が無いアーマチュアの簡易対応）※信頼性は低い
     - 右クリック `GameObject/Animation Rigging/Setup Bone Renderer (Humanoid by Name)`
3. 選択したオブジェクトに `BoneRenderer` が無い場合は自動で追加され、抽出ボーンの `Transform` が配列へ設定されます。
4. インスペクタで `BoneRenderer` を開き、`Transforms`（または `Bones`）にボーンが設定されていることを確認します。
5. それぞれのセットアップ時に色相が自動でずれて割り当てられ、複数の `BoneRenderer` が見分けやすくなります。

BoneRendererの削除は、BoneRendererが付与されたオブジェクトを選択し、右クリックメニュー `GameObject/Animation Rigging/Remove Bone Renderer(s)` を実行するか、VRChat SDKのアラート欄からのAuto Fixで削除できます。アバターアップロード時には削除しておく必要があります。

## 補足
- 変換対象は `HumanBodyBones` の列挙に存在するボーン（`LastBone` を除く）のみです。補助ボーンや IK ターゲットなどは含まれません。
- 内部的には `Animator.GetBoneTransform(HumanBodyBones)` を利用しているため、ボーン名や階層に依存しません。
- バージョンによって、`BoneRenderer` の内部配列名が `m_Transforms` または `m_Bones` の場合があります。本ツールは両方に対応しています。
- 操作は Undo に記録され、シーンは自動的に Dirty マークされます。
- 自動カラー（色相サイクル）は `Tools > Animation Rigging > Reset Bone Renderer Color Cycle` でリセットできます。
- `GameObject/Animation Rigging/Remove Bone Renderer(s)` で、選択オブジェクトに付与された `BoneRenderer` を一括削除できます。

## トラブルシューティング
- メニューがグレーアウトして実行できない：
  - 少なくとも 1 つ、`Animator` + Humanoid `Avatar` を持つ GameObject を選択しているか確認してください。
- 実行したが何も設定されない：
  - 対象の `Avatar` が Humanoid で有効（`isHuman` かつ `isValid`）か確認してください。
  - `Animation Rigging` パッケージがインストールされているか確認してください。
- 指定のボーンを除外したい：
  - スクリプトの収集処理（`CollectHumanoidTransforms`）で、不要な `HumanBodyBones` をフィルタする条件を追加してください。
 - SMR 由来モードでは Humanoid 名は保持されていません。Humanoid との関連は Animator 側のボーン集合との祖先関係で推定しています。命名に依存する「名前ベース」よりは漏れが少ないですが、独立アーマチュアの複製骨などは拾えない場合があります。

## ライセンス
MIT ライセンス。詳細は `LICENCE` を参照してください。
